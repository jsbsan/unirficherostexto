' Gambas class file

Public nombrefinalFicheroUnido As String

Public Sub Form_Open()

  Settings.Read(Me)
  ButtonLimpiar_Click()
  LabelVERSION.Text = "Version: " & Application.Version

  Wait 0.5 'carga ficheros
  ButtonCargaFicheros_Click()

End

Public Sub ButtonUNIR_Click()

  ButtonUNIR.Text = "espere....."
  Wait 0.1
  unirficheros
  Wait 0.1
  ButtonUNIR.Text = "Unir"

End

Public Sub Label1_MouseDown()

End

Public Sub Form_Close()

  Settings.Write(Me)

End

Public Sub unirficheros()

  Dim nombrefinal As String
  Dim nombres As String[]
  Dim n As String
  Dim contenido As String
  Dim horacreacion As String
  Dim rutaPorDefecto As String' para guardar los resultados de la union de ficheros
  Dim contador As Integer
  '  Dim nombrecompleto As String

  TextArea1.Text = Replace(TextArea1.text, "file://", "")
  TextArea1.Text = Replace(TextArea1.text, "\r", "")
  TextArea1.Text = Replace(TextArea1.text, "%20", " ")

  nombres = Split(TextArea1.text, "\n")
  contador = 0
  For Each n In nombres
    If Exist(n) Then
      contenido &= File.Load(n)
      ' nombrecompleto &= "_" & Replace(File.BaseName(n), "test_", "")
      contador += 1
    Endif

  Next

  horacreacion = Format(Now, "yyyy_mm_dd_hh_nn_ss")

  rutaPorDefecto = Settings["ruta", user.home & "/PDF"]
  If Exist(rutaPorDefecto) Then
    'existe, no hago nada
  Else
    'no existe la creo
    Mkdir rutaPorDefecto
  Endif

  'eliminar caracteres problematicos:ñ, Ñ,�
  TextBoxSufijo.text = Replace(TextBoxSufijo.text, "ñ", "n")
  TextBoxSufijo.text = Replace(TextBoxSufijo.text, "Ñ", "N")
  TextBoxSufijo.text = Replace(TextBoxSufijo.text, " ", "_")
  TextBoxSufijo.text = Replace(TextBoxSufijo.text, "�", "_")

  nombrefinal = rutaPorDefecto & "/unido" & horacreacion & "_" & TextBoxSufijo.text & ".csv"

  nombrefinalFicheroUnido = nombrefinal

  File.Save(nombrefinal, contenido)
  Label3.Text = nombrefinal 'para que no de problemas con el nombre muy largo"
  Label3.Tooltip = nombrefinal
  LabelTotalUnidos.Text = " " & Str(contador) & " ficheros"
  ' Message.Info("terminado de unir ficheros" & "\n" & horacreacion)
  Music.Load("cartoon048.mp3")
  Music.Volume = 20
  Music.play
  ' Desktop.Open(rutaPorDefecto)

End

Public Sub ButtonConfiguracion_Click()

  Dialog.Path = Settings["ruta"]
  If Dialog.SelectDirectory() Then
  Else

    Settings["ruta"] = Dialog.Path
  Endif

End

Public Sub ButtonLimpiar_Click()

  TextArea1.Text = ""
  Label3.Text = ""
  Label3.Tooltip = ""
  TextBoxSufijo.Text = ""
  LabelTotalUnidos.Text = ""

End

Public Sub Label3_MouseDown()

End

Public Sub ButtonAbrir_Click()

  Dim rutaPorDefecto As String

  rutaPorDefecto = Settings["ruta", user.home & "/PDF"]
  Desktop.Open(rutaPorDefecto)

End

Public Sub ButtonbORRAR_Click()

  Dim n As String
  Dim nombres As String[]
  'borra los ficheros que ha unido...
  TextArea1.Text = Replace(TextArea1.text, "file://", "")
  TextArea1.Text = Replace(TextArea1.text, "\r", "")
  TextArea1.Text = Replace(TextArea1.text, "%20", " ")

  nombres = Split(TextArea1.text, "\n")

  For Each n In nombres
    If Exist(n) Then
      Kill n
    Endif

  Next
  TextArea1.Text = ""
  TextArea1.Refresh()

End

Public Sub ButtonCargaFicheros_Click()

  Dim f As String
  Dim rutaPorDefecto As String = Settings["ruta", user.home & "/PDF"]
  Dim linea3 As String[]
  Dim token As String[]

  TextArea1.text = ""

  comprobarSiExiste(rutaPorDefecto)

  For Each f In Dir(rutaPorDefecto, "test_*.csv", gb.file).Sort()
    TextArea1.Text &= rutaPorDefecto & "/" & f & "\n"
  Next
  TextArea1.Refresh()
  Label3.Text = ""
  LabelTotalUnidos.Text = ""
  TextBoxSufijo.Text = ""

  'abrir un fichero para ver si tienen DATOS o es para calculos.
  Dim contenido As String
  Dim lineas As String[]
  Dim token2 As String[]
  Try contenido = File.Load(rutaPorDefecto & "/" & f)
  If contenido = "" Then
    Message.Info("No hay ficheros")
    Return
  Endif
  Try lineas = Split(contenido, "\n")
  Try token2 = Split(lineas[0], ";")

  If Error Then
    Message.Info("Error: ficheros vacias, revisa si NO deberia de eliminar lineas con ceros finales")
    Return
  Endif
  'analizo el 3º valor del fichero

  If token2[2] <> "\r" Then
    'son datos
    TextBoxSufijo.Text = "dat_"
  Else
    'seguramente son calculos
    TextBoxSufijo.Text = "calc_"
  Endif

  TextBoxSufijo.Text = TextBoxSufijo.Text & sugerir(token2[1])

  TextBoxSufijo.SetFocus()

End

Public Function sugerir(n As String) As String

  Dim contenido As String
  Dim lineas As String[]
  Dim a As Integer
  Dim token As String[]

  contenido = File.Load("nombres.txt")

  lineas = Split(contenido, "\n")
  For a = 0 To lineas.Count - 1
    Try token = Split(lineas[a], " ")

    Try Print n, token[0], token[1]
    If Error Then Continue

    If InStr(Upper(n), Upper(token[0])) <> 0 Then Return Replace(token[1], "\r", "") & "_"

  Next

  Return ""

End

Public Sub TextBoxSufijo_KeyPress()

  If Key.Code = Key.enter Or Key.Code = Key.return Then
    ButtonUNIR_Click()
  Endif

End

Public Sub ButtonAbrirUnido_Click()

  Shell "xed " & nombrefinalFicheroUnido

End

Public Sub comprobarSiExiste(r As String)

  If Not Exist(r) Then
    Mkdir r
  Endif

End
